// =====================================================================
// Author: Bert Berrevoets
// License: GNU GPL v3
// =====================================================================

using System;

namespace CreateMp3TestFile.Audio;

/// <summary>
/// Generates valid silent MP3 audio frames.
/// </summary>
public static class SilentMp3Generator
{
    /// <summary>
    /// A valid silent MP3 frame encoded with LAME-compatible settings.
    /// MPEG1 Layer 3, 128kbps, 44.1kHz, Joint Stereo.
    /// This frame contains properly encoded silence with valid Huffman data.
    /// </summary>
    private static readonly byte[] SilentFrame =
    {
        0xFF, 0xFB, 0x90, 0x64, 0x00, 0x0F, 0xF0, 0x00,
        0x00, 0x69, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00,
        0x0D, 0x20, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01,
        0xA4, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x34,
        0x80, 0x00, 0x00, 0x04, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55
    };

    /// <summary>
    /// Size of a single MP3 frame at 128kbps, 44.1kHz.
    /// </summary>
    private const int FrameSize = 417;

    /// <summary>
    /// Generates silent MP3 audio data of approximately the specified duration.
    /// </summary>
    /// <param name="durationSeconds">Desired duration in seconds.</param>
    /// <returns>Valid MP3 audio bytes containing silent frames.</returns>
    public static byte[] Generate(double durationSeconds)
    {
        // Each frame contains 1152 samples at 44.1kHz = ~26.12ms per frame
        const double samplesPerFrame = 1152;
        const double sampleRate = 44100;
        double secondsPerFrame = samplesPerFrame / sampleRate;

        int frameCount = (int)Math.Ceiling(durationSeconds / secondsPerFrame);
        if (frameCount < 1) frameCount = 1;

        return GenerateFrames(frameCount);
    }

    /// <summary>
    /// Generates the specified number of silent MP3 frames.
    /// </summary>
    /// <param name="frameCount">Number of frames to generate.</param>
    /// <returns>Valid MP3 audio bytes.</returns>
    public static byte[] GenerateFrames(int frameCount)
    {
        if (frameCount < 1)
            throw new ArgumentOutOfRangeException(nameof(frameCount), "Must generate at least one frame.");

        byte[] audioData = new byte[frameCount * FrameSize];

        for (int i = 0; i < frameCount; i++)
        {
            int offset = i * FrameSize;

            // Copy the silent frame template (header + side info)
            Array.Copy(SilentFrame, 0, audioData, offset, SilentFrame.Length);

            // Rest of frame is zeros (valid silent Huffman data)
        }

        return audioData;
    }

    /// <summary>
    /// Gets the duration in seconds for the specified number of frames.
    /// </summary>
    public static double GetDuration(int frameCount)
    {
        const double samplesPerFrame = 1152;
        const double sampleRate = 44100;
        return frameCount * samplesPerFrame / sampleRate;
    }
}
